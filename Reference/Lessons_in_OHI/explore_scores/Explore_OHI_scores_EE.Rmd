---
title: "Learning about OHI scores"
author: Erika Egg
output: html_document
---

```{r setup, include=FALSE}
## loading packages.. you might need to install them first
library(dplyr)
library(tidyr)
library(ggplot2)

# Erika's additions
library(readr)
```


## OH NO!
While you are working at your computer at NCEAS, you receive a frantic call from someone working on an OHI project:

THEY NEED HELP!

"No problem" you say, "I'll get Melanie or Gage"...but they are no where to be found!

"Hold on, I'll get Jamie or Casey or Courtney"...but they are also gone.

It is clearly going to be up to you to save the day!!

## You've got this!

Please help them answer the following questions.  You will work from this document, using the code chunks as a work space to work explore the data. Do NOT bother keeping the code chunks neat and organized, we want to see your work process in all its messy glory.  However, I DO recommend including plenty of comments, mostly because I have found this helps me organize my thoughts.   

You can ask us any questions along the way (slack or issues)!

Good luck!

## Questions

### Getting the data

*Goal* Read the latest OHI global data into the R working space (call the data object "scores").

*Hint* Here is a link to the data: 
https://raw.githubusercontent.com/OHI-Science/ohi-global/draft/eez/scores.csv

*Note* There are scores for 2023, you can ignore these. These are just here as a placeholder until we calculate new ones for 2023 (they are the 2022 scores). 

```{r, include=FALSE}
## Working space
# read in the csv using the link to the raw data
scores <- read_csv("https://raw.githubusercontent.com/OHI-Science/ohi-global/draft/eez/scores.csv")
```

### Region explore

*Question* Why are there N=222 regions (see code below)...aren't there supposed to be 220? Can you make this data more human readable by including the full goal name (vs. the 2 letter abbreviation) and the country name.

*Hint 1* Here is a link to the official region list (the rgn_id column in this file matches the region_id column in the scores data): https://raw.githubusercontent.com/OHI-Science/ohi-global/draft/eez/spatial/regions_list.csv

*Hint 2* Here is a table that includes goal names: https://raw.githubusercontent.com/OHI-Science/ohi-global/draft/metadata_documentation/ohi_model/tables/ten_goals.csv

*Hint 3* Which region has all NA values for scores?

*Answer* Write your answer here!

**One region has all NAs for scores and is not included (Antarctica). Another region that seems to be not included is region ID 0 which has no corresponding region name in the official region list (it's the overall index average score).**

```{r, include=FALSE}
## Working space

# get number of regions
n_regions <- length(unique(scores$region_id))
n_regions # 222

# figure out why its not 220 (look for regions that have NA for every score)
na_summary <- scores %>%
  group_by(region_id) %>%
  summarize(n_nas = sum(is.na(score))/sum(!is.na(score)))
# in this part, we find that country with id 213 has no scores that aren't NA (aka the result is Inf); this leaves one more country to find that isn't included

# add full goal name and country name columns
# read in the datatables with region names and goal names, renaming columns to match the columns we are joining on in "scores" and selecting the only relevant columns
region_names <- read_csv("https://raw.githubusercontent.com/OHI-Science/ohi-global/draft/eez/spatial/regions_list.csv") %>%
  rename(region_id = rgn_id) %>%
  select(region_id, rgn_name)
goal_names <- read_csv("https://raw.githubusercontent.com/OHI-Science/ohi-global/draft/metadata_documentation/ohi_model/tables/ten_goals.csv") %>%
  rename(goal_full = Goal,
         goal = Abbreviation) %>%
  select(goal_full, goal)

scores_joined <- scores %>% 
  left_join(region_names, by = "region_id") %>%
  left_join(goal_names, by = "goal") %>%
  select(goal_abbrev = goal, goal_full, region_id, region_name = rgn_name, dimension, year, score)

# look at just ids and associated region names in a datatable on joined scores datatable
id_and_region <- scores_joined %>%
  select(region_id, region_name) %>%
  distinct()
# we see that all ids have an associated name except id 0, so I presume this one is the other excluded one, bringing our countries down to 220
# in this table we can also see that id 213, identified before, is Antarctica
```

*Question* Which region id corresponds to the United States?
```{r}
id_and_region %>%
  filter(region_name == "United States")
```

**Looking at my id_and_region table, we can see that 163 is the United States.**


### Goal explore

*Question * When I look at the number of goals, N=19 show up....I thought there were supposed to be 10 goals!!! Can you explain what all these are? Also, why do some of the goal abbreviations have 2 letters and others 3 letters?  

*Hint 1* Review the methods doc here: https://raw.githack.com/OHI-Science/ohi-global/published/documents/methods/Supplement.html

*Answer* Write your answer here!

**There are 10 main goals and 8 subgoals (see Table 2.1 and 2.2 here for what each of these specifically are: https://raw.githack.com/OHI-Science/ohi-global/published/documents/methods/Supplement.html), with the last remaining number unaccounted for being "Index," or the overall score for each region. Two letter abbreviations correspond to main goals, while three letter abbreviations correspond to subgoals.**

```{r, include=FALSE}
## Working space
# check that it seems like n = 19
n_goals <- length(unique(scores_joined$goal_abbrev))
n_goals # looks like 19

# see what these are
abbrevs_goals <- unique(scores_joined$goal_abbrev)
abbrevs_goals 

# if we grab only 2 letter abbrevs, do we get 10?
two_let_abbrevs <- grep("^[A-Za-z]{2}$", abbrevs_goals, value = TRUE)
two_let_abbrevs
length(two_let_abbrevs) # this one is now 10
# the ones with 3 letters seem to be subgoals, and checking the methods document confirms this, which accounts for 8 of the 9 remaining abbreviations
# the last remaining one is "Index", which I will now explore further what that is
scores_joined %>%
  filter(goal_abbrev == "Index")
# after writing this brief line of code I realized that "Index" probably refers to the final score (combined from all other scores for the region), which accounts for the last one
```


### Dimension explore

*Question* There are 6 dimensions reported in this dataset (future, pressures, resilience, score, status, and trend).  When I look at the number of records in each of these categories, I notice that there are more "score" values reported than "status" values (see working space below). Given that scores are calculated using status, it seems like these should have the same number of records. Can you figure out what is going on here. Is something going wrong?  

*Answer* Write your answer here!

**In the tables below, we can see that "status" is not used in Index (aka the final score for each region). If it were used here, then that would add 2664 to Index and "status", which would make "status" records equal "score" records. "status" is factored into main goal and subgoal score calculations already, which causes it to be not needed when combining all of these individual scores to form the Index for each region. "future" is calculated using "pressures," "resilience," and "trend," which explains why those are not included for Index. Index seems to use "future" and "status" dimensions, which form "score." Combined "future" index seems to also be provided, while combined "status" index is not. Figure 2.1 here: https://raw.githack.com/OHI-Science/ohi-global/published/documents/methods/Supplement.html illustrates some of what I've said as well.**

```{r, include=FALSE}
## Working space
# look at already written code
unique(scores$dimension)
table(scores$dimension)

table(scores$goal)
table(scores$goal, scores$dimension)

# start by checking what the difference between number of records for score and for status is
diff <- table(scores$dimension)[[4]]-table(scores$dimension)[[5]]
# it is 2664, which is the same number as where there are a lot of intersections on table(scores$goal, scores$dimension)

# check this out more
doubled_diff <- diff * 2
# this corresponds to the value for Index in table(scores$goal) -- only future and score dimensions are related to index, so this makes sense
# check out future values
scores_joined %>%
  filter(dimension == "future" & goal_abbrev == "Index" & region_id == 1)

scores_joined %>%
  filter(dimension == "future" & region_id == 1) 
```


### Missing data

*Question* Figure out which goals/subgoals have the most NA values for scores in 2022 (was 2021, changed it to update for this year).  Which ones have the least? Can you discern any reason why some goals have lots of missing values and others do not?

*Hint* Include only dimension = score, and year = 2022, and cut region_id = 0.

*Answer* Write your answer here!

**CS, NP, and MAR have the most NA values for scores in 2022 (using number of NAs / total scores values ie. NA and non-NA, as a percent). Some countries don't have carbon storing habitats, for example, which is why there are so many NAs. For mariculture, they may not have a mariculture industry.**

```{r, include=FALSE}
## Working space
na_df <- scores_joined %>%
  filter(dimension == "score" & year == 2022 & region_id != 0) %>%
  select(-dimension, -year, -region_id) %>%
  group_by(goal_abbrev) %>%
  summarize(percent_nas = ( sum( is.na(score) ) / ( sum( is.na(score) ) + sum( !is.na(score) ) ) ) * 100) %>%
  arrange(desc(percent_nas))

na_df
```


### Scores

*Question* If we have a goal with a future status of 80 and status of 90...what is the score?  

*Hint* Isolate the future, status, and score values for one region and one goal and see if you can identify a pattern.

*Answer* Write your answer here!

**Score is an average of future & status values for one region and one goal. In the example, the score would be (80 + 90) / 2 = 85.**

```{r, include=FALSE}
## Working space
score_df <- scores_joined %>%
  filter(dimension %in% c("future", "status", "score") & region_id == 163 & goal_abbrev == "TR") %>%
  pivot_wider(names_from = dimension,
              values_from = score) %>%
  select(-score, everything(), score) %>%
  mutate(my_score_est = ((future + status) / 2))
# it seems like the score is an average of future and status scores
```


### Metadata

*Project* Based on your data exploration and other resources, provide some metadata that describes each variable.  Write it so it would be useful to you in the future as you are looking through these data.

Write it in the following table.  NOTE: Knit the document to see if the table is formatting correctly (but don't bother if you do not know how to knit a document or if you are running into errors!).

```{r, include=FALSE}
## Working space
goal_unique <- unique(scores$goal)
dim_unique <- unique(scores$dimension)
region_id_range <- list(min(scores$region_id), max(scores$region_id))
score_range <- list(min(scores$score, na.rm = TRUE), max(scores$score, na.rm = TRUE))
year_range <- list(min(scores$year), max(scores$year))
```

Variable   | Description                                                                                | Values
---------- | -------------------------------------------------------------------------------------------| ------------------------------
goal       |  OHI goal being scored: includes 10 main goals, 8 subgoals, and 1 overall measure (Index)  | `r goal_unique`
dimension  |  Dimension being scored for the goal, region_id, and year                                  | `r dim_unique`
region_id  |  Id that corresponds to a unique region being assessed                                     | `r region_id_range[[1]]` to `r region_id_range[[2]]`
score      |  Score value that corresponds to goal, dimension, region_id, and year                      | `r score_range[[1]]` to `r score_range[[2]]`         
year       |  Scenario year                                                                             | `r year_range[[1]]` to `r year_range[[1]]`





### Plot

*Project* Create a scatterplot that compares 2012 and 2022 *scores* for each region for the artisanal opportunities goal. Based on this, do scores for the artisanal opportunities goal appear to have increased or decreased over time? 

*Answer* Write your answer here!

**They appear to have increased, evidenced by the mean being higher in 2022. The lm lines also evidence this (if you uncomment that code instead of the mean lines).**

```{r}
## Working space
plot_1_df <- scores %>%
  filter(goal == "AO" & region_id != 0 & year %in% c(2012, 2022) & dimension == "score")

plot_1_df_means <- plot_1_df %>%
  group_by(year) %>%
  summarize(mean = mean(score, na.rm = TRUE))

plot1 <- ggplot(plot_1_df, aes(x = region_id, y = score)) +
  geom_point(aes(color = score)) +
  scale_color_gradient(low = "white",
                      high = "red") +
  facet_wrap(~year) +
  # geom_smooth(method = "lm", se = FALSE, color = "black") + # if you want lms instead
  geom_hline(data = plot_1_df_means, aes(yintercept = mean), linetype = "dashed") +
  theme_minimal() +
  labs(x = "Region ID",
       y = "Score",
       color = "",
       title = "Artisinal Fishing Opportunity scores by region, 2012 vs. 2022")

plot1 
```


Create a plot that shows the distribution (e.g., histogram or barplot or ??) of *Index* scores of all countries.

```{r across year plot}

## Code to create a plot showing distribution of country Index scores
# get a df for plotting
plot_2_df <- scores %>%
  filter(goal == "Index" & region_id != 0 & dimension == "score")

# get yearly mean scores
plot_2_df_means <- plot_2_df %>%
  group_by(year) %>%
  summarize(mean = mean(score, na.rm = TRUE))

# plot distributions faceted by year and include mean score by year
plot2 <- ggplot(plot_2_df, aes(y = score)) +
  geom_histogram(fill = "darkred") +
  facet_wrap(~year) +
  geom_hline(data = plot_2_df_means, aes(yintercept = mean), linetype = "dashed") +
  coord_flip() +
  theme_minimal() +
  labs(x = "Count",
       y = "Score",
       title = "Distribution of Index scores of all countries by year")

plot2

# show without faceting by year too
plot3 <- ggplot(plot_2_df, aes(y = score)) +
  geom_histogram(fill = "darkred") +
  coord_flip() +
  theme_minimal() +
  labs(x = "Count",
       y = "Score",
       title = "Distribution of Index scores of all countries across years")

plot3
```