---
title: "World Bank Service Earnings Data Prep"

---

# Read in Data from Mazu

```{r}
# load packages
library(tidyverse)
library(readxl)
library(here)
library(janitor)


source(here("workflow/R/common.R"))
```



```{r}
# set file paths to data in Mazu

raw_data_path <- file.path(here(dir_M, #"/home/shares/ohi"
                                "git-annex", 
                                "globalprep",
                                "_raw_data"))

un_wto_path <- file.path(here(raw_data_path, "UNWTO", "d2024"))

service_data <- file.path(un_wto_path, "join_database_w_definitions.xlsx")

```



```{r}
# read in .xlsx

service_data_raw <- read_xlsx(service_data, skip = 3, col_names = TRUE)


# quick view:


head(service_data_raw)
```

The income column we're interested in is:
Median Earnings for wage workers per month in service, local nominal currency


First, let's tidy the data and select the columns we're interested in. Then we'll join with OHI regions to see what we're working with.

```{r}
# ---------- Tidy Data ------------------------
service_data_clean <- service_data_raw %>% 
  select("Country Name", "Country Code", "Region Code", "Year of survey", "Subsample",
         "Total population", "Median Earnings for wage workers per month in service, local nominal currency") %>% 
  janitor::clean_names() %>% 
  mutate(year_of_survey = as.integer(year_of_survey),
         country_name = as.factor(country_name)) %>% 
  filter(subsample %in% c("All")) %>% # filtering to All because data also contains "Urban", "Young", etc.
  select(-subsample)

# quick look
head(service_data_clean)

# ----------- Join with OHI Regions -----------

# read in OHI regions for joining
region_names <- read_csv("https://raw.githubusercontent.com/OHI-Science/ohi-global/draft/eez/spatial/regions_list.csv") %>% 
  janitor::clean_names()


# prep column names for joining
service_clean <- service_data_clean %>% 
  rename(eez_iso3 = country_code,
         admin_country_name = country_name)


# join by country_code and eez_iso3
service_join <- inner_join(x = service_clean, region_names, by = c("eez_iso3", "admin_country_name"))

# note: many-to-many relationship bc. admin country name applies to multiple regions from region_names -- would need to note this in analysis etc.


service_join



# Filter out NAs for service wages

service_no_na <- service_join %>% 
  drop_na(median_earnings_for_wage_workers_per_month_in_service_local_nominal_currency)

service_no_na
```

Preliminary plot of wage data

```{r}
# find most recent year of data
service_newest <- service_join %>% 
  group_by(admin_country_name) %>% 
  summarize(max_year = max(year_of_survey))

# filter to years >= 2013

post_2013_data <- service_join %>% 
  filter((year_of_survey) >= 2013)



ggplot(data = post_2013_data) +
  geom_line(aes(x = year_of_survey, y = median_earnings_for_wage_workers_per_month_in_service_local_nominal_currency)) +
#  facet_wrap(~admin_country_name) +
  theme_bw()

```



Adjust service wage data to be PPP USD using OECD data
```{r}
# read in ppp data
oecd_data <- read_csv(file.path(here(un_wto_path, "SNA_TABLE4_27062024190625956.csv"))) %>% 
  janitor::clean_names()

```

Join oecd and joined service data
```{r}

service_yearly <- service_no_na %>% 
  mutate(median_annual_service_local_wages = median_earnings_for_wage_workers_per_month_in_service_local_nominal_currency 
* 12) %>% 
  select(-notes)
  
ppp_service_join <- left_join(service_yearly, oecd_data, by = c("year_of_survey" = "year", "eez_iso3" = "location"))


# filter to ones we have "value" (conversion) for

ppp_service <- ppp_service_join %>% 
  drop_na(value) %>% 
  rename(year = year_of_survey)

# selecting relevant columns
ppp_service_clean <- ppp_service %>% 
  select(
    # country info
    eez_iso3, admin_country_name, rgn_name, rgn_id, admin_rgn_id,
    # currency info
    unit_code, unit,
    # year
    year,
    # wages info
    median_earnings_for_wage_workers_per_month_in_service_local_nominal_currency,
    median_annual_service_local_wages,
    # conversion per country
    value,
    
    # type of PPP operation
    transact,
    transaction,
    
    # socio-demographic info
    total_population
  )

ppp_service_clean



# --------- Calculating Adjusted Wages -------------
# make PPP subset
# using PPP PRC:
# the PPP for Household Final Consumption (or Private Consumption) covers the expenditure by households on individual consumption of goods and services, including those sold at prices that are not economically significant.
ppp_prc <- ppp_service_clean %>% 
  filter(transact %in% c("PPPPRC"))

# check: number of unique countries, regions:
unique(ppp_prc$admin_country_name)
cat("Number of unique countries in this subset", length(unique(ppp_prc$admin_country_name)))
# 37

unique(ppp_prc$rgn_name)
cat("Number of unique regions in this subset", length(unique(ppp_prc$rgn_name)))
# 43


# make new column of adjusted wages (by year by country)!

# divide annual wage in local currency by PPP (local / USD, adjusted)

adjusted_prc <- ppp_prc %>% 
  mutate(adjusted_wages = median_annual_service_local_wages / value)


# subset for viewing

adjusted_prc %>% select(admin_country_name, rgn_name, year, value, median_annual_service_local_wages, adjusted_wages)


max(adjusted_prc$adjusted_wages)


# --------- PPP GDP -------------
# make PPP subset
# using PPP GDP: covers both final consumption expenditure (household and government) and gross capital formation
ppp_gdp <- ppp_service_clean %>% 
  filter(transact %in% c("PPPGDP"))

# check: number of unique countries, regions:
unique(ppp_gdp$admin_country_name)
cat("Number of unique countries in this subset", length(unique(ppp_gdp$admin_country_name)))
# 37

unique(ppp_gdp$rgn_name)
cat("Number of unique regions in this subset", length(unique(ppp_gdp$rgn_name)))
# 43


# make new column of adjusted wages (by year by country)!

# divide annual wage in local currency by PPP (local / USD, adjusted)

adjusted_gdp <- ppp_gdp %>% 
  mutate(adjusted_wages = median_annual_service_local_wages / value)


# subset for viewing

adjusted_gdp %>% select(admin_country_name, rgn_name, year, value, median_annual_service_local_wages, adjusted_wages)


max(adjusted_gdp$adjusted_wages)
mean(adjusted_gdp$adjusted_wages)



# --------- PPP P41 -------------
# make PPP subset
# using PPP P41: 
# or PPP for actual individual consumption covers all households consumption expenditure and that part of government final expenditure which covers services it supplies to individual households, for example housing, health, education, social protection etc ... (in other words, it does not include government final expenditure on those services it supplies to households collectively such as defense, police, environment protection ...)

ppp_p41 <- ppp_service_clean %>% 
  filter(transact %in% c("PPPP41"))

# check: number of unique countries, regions:
unique(ppp_p41$admin_country_name)
cat("Number of unique countries in this subset", length(unique(ppp_p41$admin_country_name)))
# 31

unique(ppp_p41$rgn_name)
cat("Number of unique regions in this subset", length(unique(ppp_p41$rgn_name)))
# 35


# make new column of adjusted wages (by year by country)!

# divide annual wage in local currency by PPP (local / USD, adjusted)

adjusted_p41 <- ppp_p41 %>% 
  mutate(adjusted_wages = median_annual_service_local_wages / value)


# subset for viewing

adjusted_p41 %>% select(admin_country_name, rgn_name, year, value, median_annual_service_local_wages, adjusted_wages)


max(adjusted_p41$adjusted_wages)
mean(adjusted_p41$adjusted_wages)
```


Super basic exploratory plots

```{r}
prc_plot <- adjusted_prc %>% 
  ggplot() +
  geom_line(aes(x = year, y = adjusted_wages,
                color = admin_country_name)) +
  theme_bw() +
  labs(title = "Adjusted Service Wages using PPP PRC")

gdp_plot <- adjusted_gdp %>% 
  ggplot() +
  geom_line(aes(x = year, y = adjusted_wages,
                color = admin_country_name)) +
  theme_bw() +
  labs(title = "Adjusted Service Wages using PPP GDP")

p41_plot <- adjusted_p41 %>% 
  ggplot() +
  geom_line(aes(x = year, y = adjusted_wages,
                color = admin_country_name)) +
  theme_bw() +
  labs(title = "Adjusted Service Wages using PPP P41")



prc_plot
gdp_plot
p41_plot
```

